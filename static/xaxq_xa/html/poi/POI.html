<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>POI</title>
    <!-- css -->
    <style>
        *{margin: 0; padding: 0;}
        html,body{width: 100%; height: 100%; min-width: 200px;}
    </style>
    <link rel="stylesheet" href="../../js/easyui/themes/bootstrap/easyui.css" />
    <link rel="stylesheet" href="../../js/easyui/themes/icon.css" />
    <!-- js -->
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/layer/layer.js"></script>
    <script type="text/javascript" src="../../js_con8/cm.js"></script>

	
</head>
<body style="overflow: hidden;">
    <div id="ControlTitlebar" style="background:#f3f3f3; height:25px">
        <div id="ButtonClose" style="float: right; width: 25px; height: 25px;" class="closebtn"></div>
    </div>
    <!-- 内容 -->
    <div id="my_layout" class="easyui-layout" style="width:100%;height:100%;">
        <div data-options="region:'north',border:false,collapsible:false,iconCls:'icon-search'" title="POI搜索" style="overflow: hidden; padding:5px;height: 65px;">
            <input class="easyui-searchbox" data-options="prompt:'请输入POI名称',searcher:searchClick" style="width:100%">
        </div>
        <div data-options="region:'center',border:false,iconCls:'icon-info'" title="搜索结果" style="overflow: hidden; padding:5px;">
            <div id="d_infoList" class="easyui-accordion" style="width:100%;height:100%;"></div>
        </div>
    </div>

    
</body>
<!-- js -->
<script>
    var plugin=external.parentWindow.__g;
    var console=external.parentWindow.console;
    var _POIGroupPath=external.parentWindow.Config.poiGroupPath;// POI搜索fl路径
    var _colName=external.parentWindow.Config.poiColName;// 搜索列名
    var _poiFLMap=[];
    var _flObjMap=[];
    var rowCount=0;
    var layerObj;
    $(function () {
        
        $('#d_infoList').accordion('add',{
			title:'暂无数据',
			content:'暂无数据'
        });
        $('#d_infoList').accordion('remove',0);
        loadFL();
    });
    
    // 搜索
    function searchClick(value){
        layerObj = layer.load(1,{shade: [0.7,'#ffffff']});
        if(value.length<1){
            alert("请输入搜索条件");
            setTimeout(function () { layer.close(layerObj); }, 100);
            return;
        }
        {//清除
            plugin.featureManager.unhighlightAll();
            {//清空数组
                if(_flObjMap.length>0){
                    _flObjMap.splice(0,_flObjMap.length);
                }
            }
            {//清空面板
                var panelMap=$('#d_infoList').accordion('panels');
                if(panelMap){
                    var panelCount=panelMap.length;
                    for(var i=0; i<panelCount;i++){
                        $('#d_infoList').accordion('remove',panelCount-1-i);
                    }
                }
            }
        }
        setTimeout(function () {
            // 查询 start
            {
                var is_group;
                var shtml;
                var titleName="";
                _poiFLMap.map(function(fl){
                    is_group=true;
                    shtml="";
                    //查询选中模型属性
                    var ds_fl = plugin.dataSourceFactory.openDataSourceByString(fl.featureClassInfo.dataSourceConnectionString);
                    var fds_fl = ds_fl.openFeatureDataset(fl.featureClassInfo.dataSetName);
                    var fc_fl=fds_fl.openFeatureClass(fl.featureClassInfo.featureClassName);
                    //查询
                    var filter = plugin.new_QueryFilter;
                    var sqlCheck=ds_fl.sqlCheck;
                    var sqlWhere=" \""+_colName+"\" Like '%" + value + "%'";
                    filter.whereClause=sqlCheck.checkWhereClause(sqlWhere);
                    var count=fc_fl.getCount(filter);
                    if(count>0){
                        titleName=fl.name+" ("+count+")";
                        shtml='<ul class="easyui-datalist" lines="true" style="width:100%;height:100%" data-options="onClickRow: li_Click">';
                        var cursor = fc_fl.search(filter,false);
                        if(cursor){
                            var fdeRow = null;
                            var geoIndex=-1;
                            var nameIndex=0;
                            while ((fdeRow = cursor.nextRow()) != null) {
                                if(geoIndex==-1){
                                    geoIndex=fdeRow.fieldIndex("Geometry");
                                    nameIndex=fdeRow.fieldIndex(_colName);
                                }
                                if(geoIndex>-1){
                                    var oid=fdeRow.getValue(0);
                                    var name=fdeRow.getValue(nameIndex);
                                    var geo=fdeRow.getValue(geoIndex);
                                    var env=geo.envelope.clone();
                                    _flObjMap.push({fl:fl,oid:oid,env:env});
                                    shtml+='<li value="'+(_flObjMap.length-1)+'">'+name+'</li>';
                                }
                            }
                            fdeRow=null;
                        }
                        shtml+='</ul>';
                        createList(titleName,shtml);
                        cursor=null;
                    }
                    fl_row = null;
                    fc_fl = null;
                    fds_fl = null;
                    ds_fl = null;
                    CollectGarbage();
                });
            }
            // 查询 end
            if($('#d_infoList').accordion('panels').length<1){
                $('#d_infoList').accordion('add',{
                    title:"未查到数据",
                    content:""
                });
            }
        
            setTimeout(function () { layer.close(layerObj); }, 100);
        }, 100);
    }
    // 创建数据列表
    function createList(sTitle,shtml){
        // var shtml='<ul class="easyui-datalist" lines="true" style="width:100%;height:100%">'+
        //     '<li value="AL">Alabama</li><li value="AK">Alaska</li><li value="AZ">Arizona</li>'+
        //     '</ul>';
        $('#d_infoList').accordion('add',{
			title:sTitle,
			content:shtml
        });
    }
    // 点击事件
    function li_Click(rowIndex, rowData){
        plugin.featureManager.unhighlightAll();
        if(rowData.value){
            if(rowData.value<_flObjMap.length){
                var flObj=_flObjMap[rowData.value];
                // plugin.camera.lookAtEnvelope(flObj.env);
                {
                    var ang = plugin.new_EulerAngle;
                    ang.heading = 0;
                    ang.tilt = -90;
                    plugin.camera.lookAt(flObj.env.center, 50, ang);
                }
                flObj.fl.highlightFeature(flObj.oid,0xffff0000);
            }
        }
    }
    //循环树图层
    function loadFL() {
        var poiGroupGuid = plugin.projectTree.findItem(_POIGroupPath);
        if (poiGroupGuid != "00000000-0000-0000-0000-000000000000") {
            setFL(poiGroupGuid);
        } else {
            console.log("citymaker error:", "分组路径找不到");
        }
    }
    //递归取树图层并加入树图层数组
    function setFL(guid) {
        if (plugin.projectTree.isGroup(guid)) {
            var childGuid = plugin.projectTree.getNextItem(guid, 11);
            while (childGuid != "00000000-0000-0000-0000-000000000000") {
                setFL(childGuid);
                childGuid = plugin.projectTree.getNextItem(childGuid, 13);
            }
        } else {
            var obj = plugin.objectManager.getObjectById(guid);
            if (obj.type == gviObjectType.gviObjectFeatureLayer) {
                _poiFLMap.push(obj);
            }
        }
    }
</script>
</html>
